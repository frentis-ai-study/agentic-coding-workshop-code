# ì»¤ìŠ¤í…€ GitHub Actions ì›Œí¬í”Œë¡œìš° ì˜ˆì œ
#
# ì´ íŒŒì¼ì€ ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•œ ì›Œí¬í”Œë¡œìš° ì˜ˆì œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
# .github/workflows/ ë””ë ‰í† ë¦¬ì— ë³µì‚¬í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# ============================================================
# ì˜ˆì œ 1: ì „ì²´ CI/CD íŒŒì´í”„ë¼ì¸ (All-in-One)
# ============================================================

name: Full CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST) ì •ê¸° ì‹¤í–‰
  schedule:
    - cron: '0 0 * * 1'  # UTC ê¸°ì¤€ (KST - 9ì‹œê°„)
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      run_tests:
        description: 'Run tests'
        required: true
        default: true
        type: boolean
      deploy:
        description: 'Deploy to environment'
        required: false
        type: choice
        options:
          - none
          - staging
          - production

env:
  PYTHON_VERSION: '3.12'
  UV_VERSION: '0.5.0'

jobs:
  # ============================================================
  # Job 1: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # ============================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run ruff check
        run: uv run ruff check --output-format=github .

      - name: Run ruff format check
        run: uv run ruff format --check .

      - name: Run mypy
        run: uv run mypy . --ignore-missing-imports
        continue-on-error: true  # íƒ€ì… ì²´í¬ ì‹¤íŒ¨ ì‹œì—ë„ ê³„ì† ì§„í–‰

  # ============================================================
  # Job 2: í…ŒìŠ¤íŠ¸ (ë§¤íŠ¸ë¦­ìŠ¤ë¡œ ì—¬ëŸ¬ Python ë²„ì „)
  # ============================================================
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: code-quality

    strategy:
      fail-fast: false  # í•œ ë²„ì „ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë²„ì „ ê³„ì† ì‹¤í–‰
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.python-version }}-
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests with coverage
        run: uv run pytest --cov=. --cov-report=xml --cov-report=html -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: python-${{ matrix.python-version }}
        continue-on-error: true

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: htmlcov/

  # ============================================================
  # Job 3: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  # ============================================================
  docker-build:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: myorg/agentic-coding-workshop
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push MCP server image
        uses: docker/build-push-action@v5
        with:
          context: ./04-testing-deployment/03-docker-deployment
          file: ./04-testing-deployment/03-docker-deployment/Dockerfile.mcp
          push: true
          tags: myorg/mcp-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push chat app image
        uses: docker/build-push-action@v5
        with:
          context: ./04-testing-deployment/03-docker-deployment
          file: ./04-testing-deployment/03-docker-deployment/Dockerfile.chat
          push: true
          tags: myorg/chat-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # Job 4: ë°°í¬ (ì¡°ê±´ë¶€)
  # ============================================================
  deploy:
    name: Deploy to ${{ github.event.inputs.deploy || 'none' }}
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event.inputs.deploy != 'none'

    environment:
      name: ${{ github.event.inputs.deploy }}
      url: https://${{ github.event.inputs.deploy }}.example.com

    steps:
      - name: Deploy to environment
        run: |
          echo "Deploying to ${{ github.event.inputs.deploy }}"
          # ì‹¤ì œ ë°°í¬ ëª…ë ¹ (ì˜ˆ: kubectl, terraform ë“±)

  # ============================================================
  # Job 5: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
  # ============================================================
  performance:
    name: Performance Testing
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'schedule' || github.event.inputs.run_tests == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Run performance tests
        run: |
          echo "Running performance benchmarks..."
          # ì‹¤ì œ ë²¤ì¹˜ë§ˆí¬ ë„êµ¬ ì‹¤í–‰

  # ============================================================
  # Job 6: ë³´ì•ˆ ìŠ¤ìº”
  # ============================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

# ============================================================
# ì˜ˆì œ 2: PRì— ëŒ€í•œ ìë™ ì½”ë©˜íŠ¸
# ============================================================

---
name: PR Comment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run tests and generate report
        id: test_report
        run: |
          uv sync
          uv run pytest --tb=short > test_results.txt 2>&1 || true
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          cat test_results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with test results
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ§ª Test Results\n\n\`\`\`\n${{ steps.test_report.outputs.test_output }}\n\`\`\``
            })

# ============================================================
# ì˜ˆì œ 3: ì˜ì¡´ì„± ìë™ ì—…ë°ì´íŠ¸
# ============================================================

---
name: Dependency Update

on:
  schedule:
    - cron: '0 0 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ìì • (UTC)
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Update dependencies
        run: |
          uv lock --upgrade
          uv sync

      - name: Run tests
        run: uv run pytest
        continue-on-error: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'chore: Weekly dependency update'
          body: |
            ## Dependency Update

            This PR updates all dependencies to their latest versions.

            Please review the changes and ensure all tests pass.
          branch: dependency-update
          labels: dependencies, automated
